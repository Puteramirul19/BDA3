@model BDA.ViewModel.CancellationViewModel
@{
    ViewData["Title"] = "Cancel Wang Cagaran";
    var status = Model.Status;
    var userId = User.Identity.Name;
}


@section Styles  {

    <!-- Tweaks for older IEs-->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->

    <link rel="stylesheet" href="~/assets/css/bootstrap-select/bootstrap-select.min.css">
    <style>

        .break {
            word-wrap: break-word;
        }
    </style>
}
@{
    <div class="content-inner active">
        <div class="container-fluid">
            <!-- Begin Page Header-->
            <div class="row">
                <div class="page-header">
                    <div class="d-flex align-items-center">
                        <h2 class="page-header-title">Bank Draft Cancellation</h2>
                        <div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="db-default.html"><i class="ti ti-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#">New Application</a></li>
                                <li class="breadcrumb-item active">Cancel Application</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Page Header -->
            <div class="row flex-row">
                <div class="col-xl-12">
                    <!-- Form -->
                    <div class="widget has-shadow">
                        @*<div class="widget-header bordered no-actions d-flex align-items-center">
                                <h4>Wang Cagaran</h4>
                            </div>*@
                        <div class="widget-body">
                            <div class="row flex-row justify-content-center">
                                <div class="col-xl-12">
                                    <div id="rootwizard">
                                        @Html.Partial("_StatusPendingAction.cshtml")
                                        @Html.Partial("_StatusBar.cshtml")
                                        <div class="tab-content" style="font-family: Arial">

                                            <div class="body-content">
                                                <div>
                                                    @*style="text-align:center; border-bottom: 2px solid; border-bottom-color:blue"*@
                                                    @*<h4>Submitted by: En. Requestor</h4>*@
                                                    <br>
                                                </div>

                                                <div class="widget has-shadow">
                                                    <div class="widget-body sliding-tabs">
                                                        <ul class="nav nav-tabs form-tab" id="ul-form-tab" role="tablist">
                                                            <li class="nav-item">
                                                                <a class="nav-link @((status == "Draft" || status == "Withdrawn" ||  status == "Rejected" || status == "Declined" || status == "Submitted" || status == "Approved" || status == "Complete") ? "active" : "")" id="base-tab-1" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true">Create Details</a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link @(status == "Accepted" ? "active" : "") @((status == "Accepted" || status == "Processed" || status == "Received" || status == "Complete") ? "" : "disabled")" id="base-tab-2" data-toggle="tab" href="#tab-2" role="tab" aria-controls="tab-2" aria-selected="false">Process Details</a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link  @(status == "Processed" || status == "Received" ? "active" : "") @((status == "Processed"|| status == "Received" || status == "Complete") ? "" : "disabled")" id="base-tab-3" data-toggle="tab" href="#tab-3" role="tab" aria-controls="tab-3" aria-selected="false">Submit Details</a>
                                                            </li>
                                                        </ul>
                                                        <div class="tab-content pt-3">
                                                            <div class="tab-pane fade @((status == "Draft" || status == "Rejected" || status == "Declined" || status == "Withdrawn" || status == "Submitted" || status == "Approved" || status == "Complete")? "active show" : "")" id="tab-1" role="tabpanel" aria-labelledby="base-tab-1">

                                                                @using (Html.BeginForm("Edit", "Cancellation", Model, FormMethod.Post, false, new { @id = "formEditCancellation", @class = "form-horizontal", enctype = "multipart/form-data" }))
                                                                {
                                                                    @Html.AntiForgeryToken()
                                                                    @Html.HiddenFor(x => x.Status)
                                                                    @Html.Partial("_CreateDetails.cshtml")
                                                                    @Html.Partial("_Document.cshtml")
                                                                    @Html.Partial("_ApproverList.cshtml")

                                                                    if (status != "Draft")
                                                                    {
                                                                        @Html.Partial("_ActionHistory.cshtml")
                                                                    }

                                                                    if (((status == "Rejected" || status == "Declined" || status == "Withdrawn") && Model.RequesterId == userId))
                                                                    {
                                                                        @Html.Partial("_Comment.cshtml")
                                                                    }
                                                                }
                                                                @using (Html.BeginForm("NextAction", "Cancellation", Model, FormMethod.Post, false, new { @id = "formNextAction", @class = "form-horizontal" }))
                                                                {
                                                                    if (((status == "Submitted" || status == "Draft") && Model.RequesterId == userId) || (status == "Submitted" && Model.ApproverId == userId) || (status == "Approved" && (User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin"))))
                                                                    {
                                                                        @Html.AntiForgeryToken()
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_Comment.cshtml")
                                                                    }
                                                                }

                                                            </div>
                                                            <div class="tab-pane fade @(status == "Accepted" ? "active show": "")" id="tab-2" role="tabpanel" aria-labelledby="base-tab-2">
                                                                @if (status == "Accepted" || status == "Processed" || status == "Received" || status == "Complete")
                                                                {
                                                                    @using (Html.BeginForm("SubmitToBank", "Cancellation", Model, FormMethod.Post, false, new { @id = "formSubmitToBank", @class = "form-horizontal", enctype = "multipart/form-data" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ProcessDetails.cshtml")
                                                                    }
                                                                }
                                                            </div>
                                                            <div class="tab-pane fade @(status == "Processed" || status == "Received" ? "active show": "")" id="tab-3" role="tabpanel" aria-labelledby="base-tab-3">
                                                                @if (status == "Processed" || status == "Complete")
                                                                {
                                                                    @using (Html.BeginForm("ReceiveBDCancellation", "Cancellation", Model, FormMethod.Post, false, new { @id = "formReceiveBDCancellation", @class = "form-horizontal needs-validation", @novalidate = "novalidate" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ReceiveDetails.cshtml")
                                                                        @if (status == "Processed" && (User.IsInRole("TGBS Reconciliation")))
                                                                        {
                                                                            @Html.Partial("_Comment.cshtml")
                                                                        }

                                                                    }
                                                                }
                                                                @if (status == "Received")
                                                                {

                                                                    @using (Html.BeginForm("ConfirmBDCancellation", "Cancellation", Model, FormMethod.Post, false, new { @id = "formConfirmBDCancellation", @class = "form-horizontal needs-validation", @novalidate = "novalidate" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ReceiveDetails.cshtml")
                                                                        @if (status == "Received" && (User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin")))
                                                                        {
                                                                            @Html.Partial("_Comment.cshtml")
                                                                        }

                                                                    }
                                                                }

                                                            </div>
                                                            <div class="tab-pane fade" id="tab-4" role="tabpanel" aria-labelledby="base-tab-4">

                                                            </div>
                                                            <div class="tab-pane fade" id="tab-5" role="tabpanel" aria-labelledby="base-tab-5">
                                                                @*@Html.Partial("_ActionHistory.cshtml")*@
                                                            </div>
                                                        </div>
                                                        @if ((status == "Submitted" && ((Model.ApproverId == userId) || (Model.RequesterId == userId))) || (status == "Withdrawn" && Model.RequesterId == userId) || (status == "Approved" && User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin")) || (status == "Accepted" && User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin")) || ((status == "Processed") && User.IsInRole("TGBS Reconciliation")) || ((status == "Received") && User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin")) || ((status == "Draft" || status == "Rejected" || status == "Declined") && Model.RequesterId == userId))
                                                        {
                                                            @Html.HiddenFor(x => x.UserAction)
                                                            @Html.Partial("_ActionButton.cshtml")
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            @*<a id="btnAddAccounting" class="btn btn-secondary ripple" data-toggle="modal" data-target="#add-accounting-table-modal">Add</a>*@

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Form -->
                </div>
            </div>
            <!-- End Row -->
        </div>
        <!-- End Container -->
        <!-- Begin Page Footer-->
        <!-- End Page Footer -->
        <a href="#" class="go-top"><i class="la la-arrow-up"></i></a>
        <!-- Offcanvas Sidebar -->
        @*@Html.Partial("_Log.cshtml")*@
        <!-- End Offcanvas Sidebar -->
    </div>
}

@section Scripts{
    @*Validation script*@
    <!--  validation script  -->
    <script src="~/assets/vendors/jsgrid-1.5.3/src/jsgrid.validation.js"></script>
    <script src="~/js/jquery.validate.js"></script>
    @*added by Hanif 08112019*@

    <script src="~/assets/js/components/wizard/form-wizard.min.js"></script>
    <script src="~/assets/vendors/js/bootstrap-select/bootstrap-select.min.js"></script>

    <script>

        var id = '@Model.Id';
        var cancelReason = '@Model.ReasonCancel';
        var status = '@Model.Status';
        var refNo = '@Model.RefNo';
        var letterRefNo = '@Model.InstructionLetterRefNo';
        var bdNo = '@Model.BDNo';
        var bankProcessType ='@Model.BankProcessType';
        var userId = '@User.Identity.Name'; 
        var amount = $('#BDAmount').val();
        var bdId = '@Model.BankDraftId';
        var fileId;
        var fileType;

        $("#BankDraftId").val(bdId);

        function convert(currency) {

            // Using replace() method 
            // to make currency string suitable  
            // for parseFloat() to convert  
            var temp = currency.replace(/[^0-9.-]+/g, "");

            // Converting string to float 
            // or double and return 
            return parseFloat(temp);

        } 

        $(function () {
            $("nav").addClass("shrinked");
            $("#CreateGroupBtn").show();
           
        });

        $("#btnLoadProjDetails").on('click', function () {
            $("#tblSearchResults tbody tr").remove();
            $.ajax({
                type: "GET",
                url: "/BankDraft/SearchBankDraftByProjectNonBDNo?search=" + $("#ProjectNo").val(),
                processData: false,
                contentType: false,
                success: function (data) {
                    //$("#tblSearchResults tbody tr").remove(); 
                    for (var i = 0; i < data.length; i++) {

                        //console.log(data[i]);
                        var load = "loadData('" + data[i].bankDraftId + "','" + data[i].refNo + "','" + data[i].projNo + "','" + data[i].bdNo + "','" + data[i].requester + "','" + data[i].ermsDocNo + "','" + data[i].coCode + "','" + data[i].ba + "','" + data[i].nameOnBD + "'," + data[i].bdAmount + ")";
                        $('#search-results-modal #tblSearchResults').append('<tr><td>' + data[i].refNo + '</td><td>' + data[i].projNo + '</td><td>' + data[i].requester + '</td><td>' + data[i].bdNo + '</td><td>' + data[i].ermsDocNo + '</td><td>' + data[i].ba + '</td><td>Selangor</td><td>' + data[i].ermsPostingDate + '</td><td>' + data[i].docDate + '</td><td>' + data[i].bdAmount + '</td><td>' + data[i].keteranganKerja + '</td><td><button onclick="' + load + '" type="button" class="btn btn-shadow" data-dismiss="modal">Select</button></td></tr>');
                        //$('#search-results-modal #tblSearchResults').append('<tr><td>' + data[i].projNo + '</td><td> <a href="#" onclick="' + load + '" type="button" class="btn-search-results" data-dismiss="modal">' + data[i].requester + '</a></td><td>' + data[i].ermsDocNo + '</td><td>' + data[i].ba + '</td><td>Selangor</td><td>' + data[i].ermsPostingDate + '</td><td>' + data[i].docDate + '</td><td>' + data[i].bdAmount + '</td><td>' + data[i].refNo + '</td></tr>');
                    }

                    if (data.length == 0) {
                        ShowNoty("error", "The application with project no/bank draft no does not exist or has been used.");

                    }
                }
            });

        });

        function loadData(bankDraftId, refNo, projNo, bdNo, requester, ermsDocNo, coCode, ba, nameOnBd, bdAmount) {
            $("#BankDraftId").val(bankDraftId);
            $("#RefNo").val(refNo + "/C");
            $("#ProjectNo").val(projNo);
            $("#BDNo").val(bdNo);
            $("#BDRequesterName").val(requester);
            $("#ERMSDocNo").val(ermsDocNo);
            $("#CoCode").val(coCode);
            $("#BA").val(ba);
            $("#jumlah").val("RM " + parseFloat(bdAmount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
            //$("#jumlah").val(bdAmount);
            if (nameOnBd == "") {
                $("#NameOnBD").removeAttr('disabled');
            }
            else {
                $("#NameOnBD").val(nameOnBd);
            }
          
        }

        $(document).ready(function () {


            //-- Senarai aktiviti
            var db = {

                loadData: function (filter) {
                    return $.ajax({
                        url: "/BankDraftAction/GetBankDraftActionById?id=" + id,
                        type: "GET",
                        dataType: "JSON",
                    })
                }

            };

            window.db = db;

            $("#jsGrid").jsGrid("sort", 0); 

            $("#jsGrid").jsGrid({
                width: "100%",
                filtering: false,
                editing: false,
                inserting: false,
                sorting: true,
                paging: false,
                autoload: true,
                pageSize: 10,
                pageButtonCount: 2,
                controller: db,
                fields: [
                    { name: "actionRole", title: "Action Role", width: 50, readOnly: true },
                    { name: "byId", title: "Action By", type: "myDateField", width: 150, readOnly: true },
                    { name: "comment", title: "Comment", readOnly: true, width: 150, css: "break" },
                    { name: "actionType", title: "Action Type", type: "text", width: 50, readOnly: true },
                    { name: "on", title: "Action Date", type: "text", width: 60, readOnly: true }
                ]
            });
            //--

            console.log(bankProcessType);

            SetSelectedValue('@ViewBag.ApproverId', "#ddlApprover");

            if (bankProcessType == 2) {
                SetSelectedValue("BD Cancellation - UMA", "#ddlBankProcessType");
                $('#pnl_less_oneyear').hide();
                $('#pnl_more_oneyear').show();
            }
            else {
                SetSelectedValue("BD Cancellation - Maybank", "#ddlBankProcessType");
                $('#pnl_less_oneyear').show();
                $('#pnl_more_oneyear').hide();
            }

            if (cancelReason == 1) {
                SetSelectedValue("Project On-going, Bank Draft has an error", "#ddlCancelReason");
            }
            else if (cancelReason == 2) {
                SetSelectedValue("Project On-going, Bank Draft expired", "#ddlCancelReason");
            }
            else if (cancelReason == 3) {
                SetSelectedValue("Project Completed, Bank Draft has not been used or expired", "#ddlCancelReason");
            }
            else if (cancelReason == 4) {
                SetSelectedValue("Others (for Wang Hangus)", "#ddlCancelReason");
                $('#reasonOthers').show();
            }

            //SetSelectedValue(bankProcessType, "#ddlBankProcessType");
            
            //SetSelectedValue(cancelReason, "#ddlCancelReason");

            if (status != "Draft") {

                $("#CreateGroupBtn").hide();
                $(".before-submit").hide();
                $(".after-submit").show();
                $("#trashId1").hide();
                $("#trashId2").hide();
                $("input[type=text], input[type=email], input[type=checkbox], input[type=date], select, textarea, .submission, input[type=button], input[type=file]").attr("disabled", "disabled");
                //$("input[type=text], input[type=email], input[type=checkbox], input[type=date], select, textarea, .submission").attr("disabled", "disabled");
                $(".txaComment").removeAttr('disabled');

                if (status == "Declined" || status == "Rejected" || status == "Withdrawn") {

                    if ('@Model.RequesterId' == userId) {
                        if (status == "Withdrawn") {
                            $("#stsWithdrawn").show();
                        }
                        else {
                            $("#stsRejected").show();
                        }
                        $("#CreateGroupBtn").show();

                          if ('@User.IsInRole("Business Admin")' == 'True') {
                       $("#CreateGroupBtn").hide();
                        }

                        $(".before-submit").show();
                        $(".after-submit").hide();
                        $("#trashId1").show();
                        $("#trashId2").show();
                        //$("#btnDraft").hide();
                        $("input[type=text], input[type=checkbox],input[type=email], input[type=date], select, textarea, .submission, input[type=button], input[type=file]").removeAttr('disabled');
                    }

                }

                if (status == "Draft") {
                    $("#CreateGroupBtn").show();
                     if ('@User.IsInRole("Business Admin")' == 'True') {
                       $("#CreateGroupBtn").hide();
                    }
                }
                else if (status == "Submitted") {
                    $("#stsSubmitted").show();
                    $("#tab-1 #txtComment").removeAttr('disabled');
                    $("#li-2").click();

                    if ('@Model.RequesterId' == userId) {
                        $("#WithdrawGroupBtn").show();
                    }
                    else {
                        $("#ApproveGroupBtn").show();
                    }

                     if ('@User.IsInRole("Business Admin")' == 'True') {
                         $("#ApproveGroupBtn").hide();
                    }
                }
                else if (status == "Approved") {
                    $("#stsApproved").show();
                    if ('@User.IsInRole("TGBS Banking")' == 'True'|| '@User.IsInRole("Business Admin")' == 'True') {
                        $("#AcceptGroupBtn").show();
                        $("#tab-1 #txtComment").removeAttr('disabled');
                    }
                    $("#li-3").click();
                }
                else if (status == "Accepted") {
                    $("#stsAccepted").show();
                    $("#ProcessGroupBtn").show();
                    $("#li-4").click();
                    if ('@User.IsInRole("TGBS Banking")' == 'True'|| '@User.IsInRole("Business Admin")' == 'True') {
                        $("#tab-2 input, #tab-2 select, #tab-2 textarea").removeAttr('disabled');
                      
                        $.ajax({
                            type: "GET",
                            url: "/InstructionLetter/GetInstructionLetter?refNo=" + $("#InstructionLetterRefNo").val(),
                            processData: false,
                            contentType: false,
                            success: function (data) {
                                if (data.processingType == "Bulk") {
                                    $("#SignedLetterVM_File").attr('disabled', 'disabled');
                                    ShowNoty("error", "This application's Instruction letter is processed through Bulk-Processing, please attach the Signed Letter in Bulk Processing");
                                }
                            }
                        });
                    }
                }
                else if (status == "Processed") {
                    $("#stsProcessed").show();
                    $("#ReceiveGroupBtn").show();

                     if ('@User.IsInRole("Business Admin")' == 'True') {
                         $("#ReceiveGroupBtn").hide();
                    }

                    $("#li-5").click();
                    if ('@User.IsInRole("TGBS Reconciliation")' == 'True') {
                        $("#tab-3 input, #tab-3 select, #tab-3 textarea").removeAttr('disabled');
                    }
                    $("#btnViewLetter").removeAttr('disabled');
                }
                else if (status == "Received") {
                    $("#stsReceived").show();
                    $("#CompleteGroupBtn").show();
                    $("#li-6").click();
                    if ('@User.IsInRole("TGBS Banking")' == 'True' || '@User.IsInRole("Business Admin")' == 'True') {
                        $("#tab-3 #txtComment").removeAttr('disabled');
                    }
                    $("#btnViewLetter").removeAttr('disabled');
                    
                }
                else if (status == "Complete") {
                    $("#stsSubmitted").show();
                    $("#btnViewLetter").removeAttr('disabled');
                    $("#li-7").click();
                }
            
            }

          //Add new role - Viewer cant view Bank Details tab 22/02/2021
            if ('@User.IsInRole("Viewer")' == 'True') {

                if (status == "Accepted") {
                    $("#tab-2").removeClass("active show");
                    $("#tab-1").addClass("active show");
                }

                $("#base-tab-2").removeClass("active");
                $("#base-tab-2").addClass("disabled");

            }
            var ilrn = letterRefNo;

            if (ilrn !== "") {
                $("#InstructionLetterRefNo").attr("disabled", "disabled");
                $("#btnNewLetter").hide();
                $("#btnViewLetter").show();
                $("#btnEditLetter").show();
            }


            $("#InstructionLetterRefNo").blur(function (e) {
                $.ajax({
                    type: "POST",
                    url: "/InstructionLetter/SetCancellationInstructionLetter?LetterRefNo=" + $(this).val() + "&bdRefNo=" + refNo,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.response.statusCode == 200) {
                            ShowNoty("success", data.message);
                            $("#InstructionLetterRefNo").attr("disabled", "disabled");
                            $("#btnNewLetter").hide();
                            $("#btnViewLetter").show();
                            $("#btnEditLetter").show();
                        } else {
                            ShowNoty("error", data.message);
                        }
                    }
                });
            });

            $("#ddlBankProcessType").select2({
                minimumResultsForSearch: -1,
                ajax: {
                    url: "/Cancellation/GetAllBankProcessType",
                    dataType: 'json',
                    type: "GET",
                    processResults: function (data) {
                        console.log(data);
                        return {
                            results: $.map(data, function (item) {
                                return {
                                    text: item.name,
                                    id: item.id
                                }

                            })
                        };
                    }
                }
            });

            $("#ddlApprover").select2({
                minimumResultsForSearch: -1,
                ajax: {
                    url: "/Cancellation/GetAllCancellationApprover",
                    dataType: 'json',
                    type: "GET",
                    processResults: function (data) {
                        return {
                            results: $.map(data, function (item) {
                                return {
                                    text: item.name,
                                    id: item.id
                                }

                            })
                        };
                    }
                }
            });

            $('#ddlApprover').on('select2:select', function (e) {
                var data = e.params.data;
                if (data.selected) {
                    var id = data.id;
                    $("#ApproverId").val(id);
                }
            });

            $('#ddlCancelReason').on('change', function (e) {
                if (this.value == "4") {
                    $('#reasonOthers').show();
                } else {
                    $('#reasonOthers').hide();
                }
            });

            $("#ddlCancelReason").select2({
                minimumResultsForSearch: -1,
                ajax: {
                    url: "/Cancellation/GetAllCancellationReason",
                    dataType: 'json',
                    type: "GET",
                    processResults: function (data) {
                        console.log(data);
                        return {
                            results: $.map(data, function (item) {
                                return {
                                    text: item.name,
                                    id: item.id
                                }

                            })
                        };
                    }
                }
            });

            $('#ddlCancelReason').on('select2:select', function (e) {
                var data = e.params.data;
                if (data.selected) {
                    cancelReason = data.id;
                    //$("#WangCagaranViewModel.Negeri").val(data.text);
                }
            });

            //$('#ddlBankProcessType').on('select2:select', function (e) {
            //    var data = e.params.data;
            //    if (data.selected) {
            //        bankProcessType = data.text;
            //    }
            //});

            $('#ddlBankProcessType').on('select2:select', function (e) {
                var data = e.params.data;
                if (data.selected) {
                    //var id = data.id;
                    bankProcessType = data.id;

                    if (bankProcessType == "1") {
                        $('#pnl_less_oneyear').show();
                        $('#pnl_more_oneyear').hide();
                        bankProcessType = "1";
                        $("#BankProcessType").val("1");
                    }
                    else {
                        $('#pnl_less_oneyear').hide();
                        $('#pnl_more_oneyear').show();
                        bankProcessType = "2";
                        $("#BankProcessType").val("2");
                    
                    }
                }
            });

            $('#jumlah').on('keyup click change paste input', function (event) {
                $(this).val(function (index, value) {
                    if (value != "") {
                        //return '$' + value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        var decimalCount;
                        value.match(/\./g) === null ? decimalCount = 0 : decimalCount = value.match(/\./g);

                        if (decimalCount.length > 1) {
                            value = value.slice(0, -1);
                        }

                        var components = value.toString().split(".");
                        if (components.length === 1)
                            components[0] = value;
                        components[0] = components[0].replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        if (components.length === 2) {
                            components[1] = components[1].replace(/\D/g, '').replace(/^\d{3}$/, '');
                        }

                        if (components.join('.') != '')
                            return 'RM ' + components.join('.');
                        else
                            return '';
                    }
                });
            });
        });

        //function RemoveAttachment(id, type) {
        //    ShowNoty("warning", "Deleting Attachment..");
        //    $.ajax({
        //        type: "GET",
        //        url: "/BankDraft/RemoveAttachment/" + id,
        //        processData: false,
        //        contentType: false,
        //        success: function (data) {
        //            if (data.response.statusCode == 200) {
        //                $('#hdnWCSuratKelulusan').val("");
        //                $('#noFile-' + type).show();
        //                $('#hasFile-' + type).hide();
        //                ShowNoty("success", data.message);
        //            } else {
        //                ShowNoty("error", data.message);
        //            }
        //        }
        //    });
        //}

        function RemoveAttachment(id, type) {

            fileId = id;
            fileType = type;

            $("#confirmation-remove-attachment-modal").modal({
                backdrop: 'static',
                keyboard: false
            });

        }

        $('#btnRemoveAttachment').on('click', function (e) {
            ShowNoty("warning", "Deleting Attachment..");
            $.ajax({
                type: "GET",
                url: "/BankDraft/RemoveAttachment/" + fileId,
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log('hello ' + data.response.statusCode);
                    if (data.response.statusCode == 200) {
                        $('#hdnWCSuratKelulusan').val("");
                        $('#noFile-' + fileType).show();
                        $('#hasFile-' + fileType).hide();
                        ShowNoty("success", data.message);
                        refresh();
                    } else {
                        ShowNoty("error", data.message);
                    }

                }
            });
        });

        //button to create letter
        $('#btnNewLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/CreateCancellation?RefNo=" + $("#RefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });
        $('#btnViewLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/CancellationLetter?LetterRefNo=" + $("#InstructionLetterRefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });
        $('#btnEditLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/EditCancellation?LetterRefNo=" + $("#InstructionLetterRefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });

        $("#btnDraft").on('click', function (e) {
                $("#Status").val("Draft");
                $("#formEditCancellation").submit();
        });

        $("#btnCreateConfirm").on('click', function (e) {
            console.log('create confirm');
            if ($("#formEditCancellation").valid()) {
                $("#Status").val("Submit");
                $("#formEditCancellation").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
           
        });

        $('#btnWithdrawConfirm').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Withdrawn");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $("#btnApprove").on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Approve");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnRejectApprove').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("RejectApprove");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnAccept').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Accept");
                $("#formNextAction").submit();
            } else {
                ShowNoty("error", "Please fill all required fields!");
            }    
            
        });

        $('#btnDeclined').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Decline");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnSaveProcess').on('click', function (e) {
            if ($("#formSubmitToBank").valid()) {
                $("#UserAction").val("Draft");
                $("#formSubmitToBank").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnSubmitToBank').on('click', function (e) {
            if ($("#formSubmitToBank").valid()) {
                $("#UserAction").val("SubmitToBank");
                $("#formSubmitToBank").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnReceiveBD').on('click', function (e) {
            if ($("#formReceiveBDCancellation").valid()) {
                $("#UserAction").val("ReceiveBDCancellation");
                $("#formReceiveBDCancellation").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
           
        });


        $('#btnCompleteConfirm').on('click', function (e) {
            if ($("#formConfirmBDCancellation").valid()) {
                $("#UserAction").val("Complete");
                $("#formConfirmBDCancellation").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        
        });

        $("#formEditCancellation").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            amount = $('#jumlah').val();
            //alert(amount);
            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            fdata.append("BDAmount", convert(amount));

            var fileInput = $('#ScannedBankDraftVM_File')[0];
            var file = fileInput.files[0];
            fdata.append("ScannedBankDraft", file);

            var fileInput = $('#ScannedMemoVM_File')[0];
            var file = fileInput.files[0];
            fdata.append("ScannedMemo", file);

            fdata.append("ReasonCancel", cancelReason);

            $("input[type='text'], input[type='hidden']").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            // You can update the jquery selector to use a css class if you want
            $("input,textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            for (var value of fdata.values()) {
                console.log(value);
            }
            for (var key of fdata.keys()) {
                console.log(key);
            }

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        href = "/Application/MyCancellation";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                    }
                }
            });
        });

        $("#formNextAction").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.
            ShowNoty("warning", "Updating Application..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();
            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    if (data.response.statusCode == 200) {
                       
                        if ($("#UserAction").val() == "Decline") {
                            ShowNoty("success", "Declined Successful");
                        }
                        else {
                            ShowNoty("success", data.message);
                        }

                        if ($("#UserAction").val() == "Approve") {
                            $('#approve-modal').modal('show'); 
                        }
                        else if ($("#UserAction").val() == "Accept") {
                            $('#accept-modal').modal('show'); 
                        }
                        if ($("#UserAction").val() == "Withdrawn") {
                            href = "/Cancellation/Edit/" + data.id;
                        }
                        else {
                            href = "/Application/ManageCancellation";
                        }
                      
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                       
                    }
                }
            });
        });

        $("#formSubmitToBank").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            if ($('#SignedLetterVM_File').get(0).files.length !== 0) {
                var fileInput = $('#SignedLetterVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("SignedLetter", file);
            }

            if ($('#UMAPinFormVM_File').get(0).files.length !== 0) {
                var fileInput = $('#UMAPinFormVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("UMAPinForm", file);
            }

            if ($('#ScannedLetterVM_File').get(0).files.length !== 0) {
                var fileInput = $('#ScannedLetterVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("ScannedLetter", file);
            }
            if (bankProcessType == "") {
                bankProcessType = "1";
            }
            console.log("bank: " + bankProcessType);
            fdata.append("BankProcessType", bankProcessType);
            // You can update the jquery selector to use a css class if you want
            $("input, select, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            for (var value of fdata.values()) {
                console.log(value);
            }
            for (var key of fdata.keys()) {
                console.log(key);
            }
            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        $('#process-modal').modal('show'); 

                        href = "/Application/ManageCancellation";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                     
                    }
                }
            });
        });

        $("#formReceiveBDCancellation").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            if ($('#BankStatementVM_File').get(0).files.length !== 0) {
                var fileInput = $('#BankStatementVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("BankStatement", file);
            }

            // You can update the jquery selector to use a css class if you want
            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            for (var value of fdata.values()) {
                console.log(value);
            }
            for (var key of fdata.keys()) {
                console.log(key);
            }

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        $('#receive-modal').modal('show'); 

                        href = "/Application/ManageCancellation";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                      
                    }
                }
            });
        });

        $("#formConfirmBDCancellation").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            // You can update the jquery selector to use a css class if you want
            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        $('#complete-modal').modal('show'); 
                    
                        href = "/Application/ManageCancellation";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                     
                    }
                }
            });
        });

    </script>

}


