@model BDA.ViewModel.LostViewModel
@{
    ViewData["Title"] = "Lost Bank Draft";
    var status = Model.Status;
    var userId = User.Identity.Name;
}


@section Styles  {

    <!-- Tweaks for older IEs-->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->

    <link rel="stylesheet" href="~/assets/css/bootstrap-select/bootstrap-select.min.css">
    <style>
        .break {
            word-wrap: break-word;
        }
    </style>
}
@{
    <div class="content-inner active">
        <div class="container-fluid">
            <!-- Begin Page Header-->
            <div class="row">
                <div class="page-header">
                    <div class="d-flex align-items-center">
                        <h2 class="page-header-title">Bank Draft Lost</h2>
                        <div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/Lost/BankDraftList"><i class="ti ti-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#">New Application</a></li>
                                <li class="breadcrumb-item"><a href="#">Lost Application</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Page Header -->
            <div class="row flex-row">
                <div class="col-xl-12">
                    <!-- Form -->
                    <div class="widget has-shadow">
                        @*<div class="widget-header bordered no-actions d-flex align-items-center">
                                <h4>Wang Cagaran</h4>
                            </div>*@
                        <div class="widget-body">
                            <div class="row flex-row justify-content-center">
                                <div class="col-xl-12">
                                    <div id="rootwizard">
                                        @Html.Partial("_StatusPendingAction.cshtml")
                                        @Html.Partial("_StatusBar.cshtml")
                                        <div class="tab-content" style="font-family: Arial">

                                            <div class="body-content">
                                                <div>
                                                    @*style="text-align:center; border-bottom: 2px solid; border-bottom-color:blue"*@
                                                    @*<h4>Submitted by: En. Requestor</h4>*@
                                                    <br>
                                                </div>

                                                <div class="widget has-shadow">
                                                    <div class="widget-body sliding-tabs">
                                                        <ul class="nav nav-tabs form-tab" id="ul-form-tab" role="tablist">
                                                            <li class="nav-item">
                                                                <a class="nav-link @((status == "Draft" || status == "Withdrawn" ||  status == "Rejected" || status == "Declined" || status == "Submitted" || status == "Approved" || status == "Complete") ? "active" : "")" id="base-tab-1" data-toggle="tab" href="#tab-1" role="tab" aria-controls="tab-1" aria-selected="true">Create Details</a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link @(status == "Accepted" ? "active" : "") @((status == "Accepted" || status == "Processed" || status == "Received" || status == "Complete") ? "" : "disabled")" id="base-tab-2" data-toggle="tab" href="#tab-2" role="tab" aria-controls="tab-2" aria-selected="false">Process Details</a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link  @(status == "Processed" || status == "Received" ? "active" : "") @((status == "Processed"|| status == "Received" || status == "Complete") ? "" : "disabled")" id="base-tab-3" data-toggle="tab" href="#tab-3" role="tab" aria-controls="tab-3" aria-selected="false">Submit Details</a>
                                                            </li>
                                                        </ul>
                                                        <div class="tab-content pt-3">
                                                            <div class="tab-pane fade @((status == "Draft" || status == "Rejected" || status == "Declined" || status == "Withdrawn" || status == "Submitted" || status == "Approved" || status == "Complete")? "active show" : "")" id="tab-1" role="tabpanel" aria-labelledby="base-tab-1">

                                                                @using (Html.BeginForm("Edit", "Lost", Model, FormMethod.Post, false, new { @id = "formEditLost", @class = "form-horizontal", enctype = "multipart/form-data" }))
                                                                {
                                                                    @Html.AntiForgeryToken()
                                                                    @Html.HiddenFor(x => x.Status)
                                                                    @Html.HiddenFor(x => x.UserAction)
                                                                    @Html.Partial("_CreateDetails.cshtml")
                                                                    @Html.Partial("_Document.cshtml")
                                                                    @Html.Partial("_ApproverList.cshtml")

                                                                    if (status != "Draft")
                                                                    {
                                                                        @Html.Partial("_ActionHistory.cshtml")
                                                                    }

                                                                    if (status == "Draft")
                                                                    {
                                                                        @Html.Partial("_Comment.cshtml")
                                                                    }
                                                                }
                                                                @using (Html.BeginForm("NextAction", "Lost", Model, FormMethod.Post, false, new { @id = "formNextAction", @class = "form-horizontal" }))
                                                                {
                                                                    if (((status == "Submitted" || status == "Rejected" || status == "Declined" || status == "Withdrawn") && Model.RequesterId == userId))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_Comment.cshtml")
                                                                    }

                                                                    if ((status == "Submitted" && Model.ApproverId == userId) || (status == "Approved" && User.IsInRole("TGBS Banking")) || (status == "Approved" && User.IsInRole("Business Admin")))
                                                                    {
                                                                        @Html.AntiForgeryToken()
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_Comment.cshtml")
                                                                    }
                                                                }

                                                            </div>
                                                            <div class="tab-pane fade @(status == "Accepted" ? "active show": "")" id="tab-2" role="tabpanel" aria-labelledby="base-tab-2">
                                                                @if (status == "Accepted" || status == "Processed" || status == "Received" || status == "Complete")
                                                                {
                                                                    @using (Html.BeginForm("SubmitToBank", "Lost", Model, FormMethod.Post, false, new { @id = "formSubmitToBank", @class = "form-horizontal", enctype = "multipart/form-data" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ProcessDetails.cshtml")
                                                                    }
                                                                }
                                                            </div>
                                                            <div class="tab-pane fade @(status == "Processed" || status == "Received" ? "active show": "")" id="tab-3" role="tabpanel" aria-labelledby="base-tab-3">
                                                                @if (status == "Processed" || status == "Complete")
                                                                {
                                                                    @using (Html.BeginForm("ReceiveBDLost", "Lost", Model, FormMethod.Post, false, new { @id = "formReceiveBDLost", @class = "form-horizontal needs-validation", @novalidate = "novalidate" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ReceiveDetails.cshtml")
                                                                        @if (status == "Processed" && (User.IsInRole("TGBS Reconciliation")))
                                                                        {
                                                                            @Html.Partial("_Comment.cshtml")
                                                                        }

                                                                    }
                                                                }
                                                                @if (status == "Received")
                                                                {

                                                                    @using (Html.BeginForm("ConfirmBDLost", "Lost", Model, FormMethod.Post, false, new { @id = "formConfirmBDLost", @class = "form-horizontal needs-validation", @novalidate = "novalidate" }))
                                                                    {
                                                                        @Html.HiddenFor(x => x.UserAction)
                                                                        @Html.Partial("_ReceiveDetails.cshtml")
                                                                        @if (status == "Received" && ((User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin"))))
                                                                        {
                                                                            @Html.Partial("_Comment.cshtml")
                                                                        }

                                                                    }
                                                                }

                                                            </div>
                                                            <div class="tab-pane fade" id="tab-4" role="tabpanel" aria-labelledby="base-tab-4">

                                                            </div>
                                                            <div class="tab-pane fade" id="tab-5" role="tabpanel" aria-labelledby="base-tab-5">
                                                                @*@Html.Partial("_ActionHistory.cshtml")*@
                                                            </div>
                                                        </div>
                                                        @if ((status == "Submitted" && ((Model.ApproverId == userId) || (Model.RequesterId == userId))) || (status == "Withdrawn" && Model.RequesterId == userId) || (status == "Approved" && (User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin"))) || (status == "Accepted" && (User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin"))) || ((status == "Processed") && User.IsInRole("TGBS Reconciliation")) || ((status == "Received") && (User.IsInRole("TGBS Banking") || User.IsInRole("Business Admin"))) || ((status == "Draft" || status == "Rejected" || status == "Declined") && Model.RequesterId == userId))
                                                        {
                                                            @Html.HiddenFor(x => x.UserAction)
                                                            @Html.Partial("_ActionButton.cshtml")
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            @*<a id="btnAddAccounting" class="btn btn-secondary ripple" data-toggle="modal" data-target="#add-accounting-table-modal">Add</a>*@

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Form -->
                </div>
            </div>
            <!-- End Row -->
        </div>
        <!-- End Container -->
        <!-- Begin Page Footer-->
        <!-- End Page Footer -->
        <a href="#" class="go-top"><i class="la la-arrow-up"></i></a>
        <!-- Offcanvas Sidebar -->
        @*@Html.Partial("_Log.cshtml")*@
        <!-- End Offcanvas Sidebar -->
    </div>
}

@section Scripts{
    @*Validation script*@
    <!--  validation script  -->
    <script src="~/assets/vendors/jsgrid-1.5.3/src/jsgrid.validation.js"></script>
    <script src="~/js/jquery.validate.js"></script>
    @*added by Hanif 08112019*@

    <script src="~/assets/js/components/wizard/form-wizard.min.js"></script>
    <script src="~/assets/vendors/js/bootstrap-select/bootstrap-select.min.js"></script>
    <script src="~/assets/vendors/js/datatables/datatables2.min.js"></script>
    @*<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>*@

    <script>

        var id = '@Model.Id';
        var status = '@Model.Status';
        var refNo = '@Model.RefNo';
        var letterRefNo = '@Model.InstructionLetterRefNo';
        var bankProcessType ='@Model.BankProcessType';
        var userId = '@User.Identity.Name';
        var counter1;
        var counter2 = 0;
        var amount = $('#BDAmount').val();
        var fileId;
        var fileType;

        function convert(currency) {

            // Using replace() method
            // to make currency string suitable
            // for parseFloat() to convert
            var temp = currency.replace(/[^0-9.-]+/g, "");

            // Converting string to float
            // or double and return
            return parseFloat(temp);

        }

        function popupwindow(url, title, w, h) {
            var y = window.outerHeight / 2 + window.screenY - (h / 2)
            var x = window.outerWidth / 2 + window.screenX - (w / 2)
            return window.open(url, title, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=' + w + ', height=' + h + ', top=' + y + ', left=' + x);
        }

        $(function () {
            $("nav").addClass("shrinked");
            $("#CreateGroupBtn").show();

        });

        $("#btnLoadProjDetails").on('click', function () {
            $("#tblSearchResults tbody tr").remove();
            $.ajax({
                type: "GET",
                url: "/BankDraft/SearchBankDraftByProjectNonBDNo?search=" + $("#ProjectNo").val(),
                processData: false,
                contentType: false,
                success: function (data) {
                    //$("#tblSearchResults tbody tr").remove();
                    for (var i = 0; i < data.length; i++) {

                        console.log(data[i]);
                        var load = "loadData('" + data[i].bankDraftId + "','" + data[i].refNo + "','" + data[i].projNo + "','" + data[i].bdNo + "','" + data[i].requester + "','" + data[i].ermsDocNo + "','" + data[i].coCode + "','" + data[i].ba + "','" + data[i].nameOnBD + "'," + data[i].bdAmount + ")";
                        $('#search-results-modal #tblSearchResults').append('<tr><td>' + data[i].refNo + '</td><td>' + data[i].projNo + '</td><td>' + data[i].requester + '</td><td>' + data[i].bdNo + '</td><td>' + data[i].ermsDocNo + '</td><td>' + data[i].ba + '</td><td>Selangor</td><td>' + data[i].ermsPostingDate + '</td><td>' + data[i].docDate + '</td><td>' + data[i].bdAmount + '</td><td>' + data[i].keteranganKerja + '</td><td><button onclick="' + load + '" type="button" class="btn btn-shadow" data-dismiss="modal">Select</button></td></tr>');
                        //$('#search-results-modal #tblSearchResults').append('<tr><td>' + data[i].projNo + '</td><td> <a href="#" onclick="' + load + '" type="button" class="btn-search-results" data-dismiss="modal">' + data[i].requester + '</a></td><td>' + data[i].ermsDocNo + '</td><td>' + data[i].ba + '</td><td>Selangor</td><td>' + data[i].ermsPostingDate + '</td><td>' + data[i].docDate + '</td><td>' + data[i].bdAmount + '</td><td>' + data[i].refNo + '</td></tr>');
                    }
                    if (data.length == 0) {
                        ShowNoty("error", "The application with project no/bank draft no does not exist or has been used.");

                    }
                }
            });

        });

        function loadData(bankDraftId, refNo, projNo, bdNo, requester, ermsDocNo, coCode, ba, nameOnBd, bdAmount) {
            $("#BankDraftId").val(bankDraftId);
            $("#RefNo").val(refNo + "/L");
            $("#ProjectNo").val(projNo);
            $("#BDNo").val(bdNo);
            $("#BDRequesterName").val(requester);
            $("#ERMSDocNo").val(ermsDocNo);
            $("#CoCode").val(coCode);
            $("#BA").val(ba);
            $("#BDAmount").val(bdAmount);
            if (nameOnBd == "") {
                $("#NameOnBD").removeAttr('disabled');
            }
            else {
                $("#NameOnBD").val(nameOnBd);
            }
        }

        $(document).ready(function () {

            //-- Senarai aktiviti
            var db = {

                loadData: function (filter) {
                    return $.ajax({
                        url: "/BankDraftAction/GetBankDraftActionById?id=" + id,
                        type: "GET",
                        dataType: "JSON",
                    })
                }

            };

            window.db = db;

            $("#jsGrid").jsGrid("sort", 0);

            $("#jsGrid").jsGrid({
                width: "100%",
                filtering: false,
                editing: false,
                inserting: false,
                sorting: true,
                paging: false,
                autoload: true,
                pageSize: 10,
                pageButtonCount: 2,
                controller: db,
                fields: [
                    { name: "actionRole", title: "Action Role", width: 50, readOnly: true },
                    { name: "byId", title: "Action By", type: "myDateField", width: 150, readOnly: true },
                    { name: "comment", title: "Comment", readOnly: true, width: 150, css: "break" },
                    { name: "actionType", title: "Action Type", type: "text", width: 50, readOnly: true },
                    { name: "on", title: "Action Date", type: "text", width: 60, readOnly: true }
                ]
            });
            //--

            console.log(bankProcessType);

            SetSelectedValue('@ViewBag.ApproverId', "#ddlApprover");

            if (status != "Draft") {

                $("#CreateGroupBtn").hide();
                $(".before-submit").hide();
                $(".after-submit").show();
                $(".before-process").hide();
                $("#addRow").hide();
                $("#suppDoc tbody #dustbinId").hide();
                $("input[type=text], input[type=file], input[type=email], input[type=checkbox], input[type=date], select, textarea, .submission, input[type=button]").attr("disabled", "disabled");
                //$("input[type=text], input[type=email], input[type=checkbox], input[type=date], select, textarea, .submission").attr("disabled", "disabled");
                $(".txaComment").removeAttr('disabled');

                if (status == "Declined" || status == "Rejected" || status == "Withdrawn") {

                    if ('@Model.RequesterId' == userId) {
                        if (status == "Withdrawn") {
                            $("#stsWithdrawn").show();
                        }
                        else {
                            $("#stsRejected").show();
                            
                        }

                        $("#CreateGroupBtn").show();

                         if ('@User.IsInRole("Business Admin")' == 'True') {
                             $("#CreateGroupBtn").hide();
                        }
                        $(".before-submit").show();
                        $(".after-submit").hide();
                        //$("#btnDraft").hide();
                        $("#addRow").show();
                        $("input[type=text], input[type=checkbox],input[type=email], input[type=date], select, textarea, .submission, input[type=button], input[type=file]").removeAttr('disabled');
                    }

                }

                if (status == "Draft") {
                    $("#CreateGroupBtn").show();

                      if ('@User.IsInRole("Business Admin")' == 'True') {
                          $("#CreateGroupBtn").hide();
                    }
                }
                else if (status == "Submitted") {
                    $("#stsSubmitted").show();
                    $("#tab-1 #txtComment").removeAttr('disabled');
                    $("#li-2").click();

                    if ('@Model.RequesterId' == userId) {
                        $("#WithdrawGroupBtn").show();
                    }
                    else {
                        $("#ApproveGroupBtn").show();
                    }

                      if ('@User.IsInRole("Business Admin")' == 'True') {
                          $("#ApproveGroupBtn").hide();
                    }
                }
                else if (status == "Approved") {
                    $("#stsApproved").show();
                    $("#AcceptGroupBtn").show();
                    if ('@User.IsInRole("TGBS Banking")' == 'True' || '@User.IsInRole("Business Admin")' == 'True') {
                        $("#tab-1 #txtComment").removeAttr('disabled');
                    }
                    $("#li-3").click();
                }
                else if (status == "Accepted") {
                    $("#stsAccepted").show();
                    $("#li-4").click();

                    if ('@User.IsInRole("TGBS Banking")' == 'True' || '@User.IsInRole("Business Admin")' == 'True') {
                        $(".before-process").show();
                         $("#tab-2 input, #tab-2 select, #tab-2 textarea").removeAttr('disabled');
                         $("#ProcessGroupBtn").show();
                     }
                }
                else if (status == "Processed") {
                    $("#stsProcessed").show();
                    $("#li-5").click();
                  
                    if ('@User.IsInRole("TGBS Reconciliation")' == 'True') {
                        $("#tab-3 input, #tab-3 select, #tab-3 textarea, #tab-3 file").removeAttr('disabled');
                        $("#ReceiveGroupBtn").show();
                    }

                    if ('@User.IsInRole("Business Admin")' == 'True') {
                            $("#ReceiveGroupBtn").hide();
                    }
                }
                else if (status == "Received") {
                    $("#stsReceived").show();
                    $("#li-6").click();
                    //$("#tab3 file").removeAttr('disabled');
                     if ('@User.IsInRole("TGBS Banking")' == 'True' || '@User.IsInRole("Business Admin")' == 'True') {
                         $("#tab-3 #txtComment").removeAttr('disabled');
                         $("#CompleteGroupBtn").show();
                    }
                }
                else if (status == "Complete") {
                    $("#stsCompleted").show();
                    $("#btnViewLetter").removeAttr('disabled');
                    $("#li-7").click();
                }

            }

              //Add new role - Viewer cant view Bank Details tab 22/02/2021
            if ('@User.IsInRole("Viewer")' == 'True') {

                if (status == "Accepted") {
                    $("#tab-2").removeClass("active show");
                    $("#tab-1").addClass("active show");
                }

                $("#base-tab-2").removeClass("active");
                $("#base-tab-2").addClass("disabled");

            }

            var ilrn = letterRefNo;

            if (ilrn !== "") {
                $("#InstructionLetterRefNo").attr("disabled", "disabled");
                $("#btnNewLetter").hide();
                $("#btnViewLetter").show();
                $("#btnEditLetter").show();
            }


            $("#InstructionLetterRefNo").blur(function (e) {
                $.ajax({
                    type: "POST",
                    url: "/InstructionLetter/SetLostInstructionLetter?LetterRefNo=" + $(this).val() + "&bdRefNo=" + refNo,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.response.statusCode == 200) {
                            ShowNoty("success", data.message);
                            $("#InstructionLetterRefNo").attr("disabled", "disabled");
                            $("#btnNewLetter").hide();
                            $("#btnViewLetter").show();
                            $("#btnEditLetter").show();
                        } else {
                            ShowNoty("error", data.message);
                        }
                    }
                });
            });


            $("#ddlApprover").select2({
                minimumResultsForSearch: -1,
                ajax: {
                    url: "/Lost/GetAllLostApprover",
                    dataType: 'json',
                    type: "GET",
                    processResults: function (data) {
                        return {
                            results: $.map(data, function (item) {
                                return {
                                    text: item.name,
                                    id: item.id
                                }

                            })
                        };
                    }
                }
            });

            $('#ddlApprover').on('select2:select', function (e) {
                var data = e.params.data;
                if (data.selected) {
                    var id = data.id;
                    $("#ApproverId").val(id);
                }
            });

        });

        var counts = 1;

        //function RemoveAttachment(id, type) {
        //    ShowNoty("warning", "Deleting Attachment..");

        //    $.ajax({
        //        type: "GET",
        //        url: "/BankDraft/RemoveAttachment/" + id,
        //        processData: false,
        //        contentType: false,
        //        success: function (data) {
        //            if (data.response.statusCode == 200) {
        //                $('#hdn' + type).val("");
        //                $('#hasFile-' + type).hide();
        //                $('#noFile-' + type).show();
        //                ShowNoty("success", data.message);
        //            } else {
        //                ShowNoty("error", data.message);
        //            }
        //        }
        //    });
        //}

        function RemoveAttachment(id, type) {

            fileId = id;
            fileType = type;

            $("#confirmation-remove-attachment-modal").modal({
                backdrop: 'static',
                keyboard: false
            });

        }

        $('#btnRemoveAttachment').on('click', function (e) {
            ShowNoty("warning", "Deleting Attachment..");
            $.ajax({
                type: "GET",
                url: "/BankDraft/RemoveAttachment/" + fileId,
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log('hello ' + data.response.statusCode);
                    if (data.response.statusCode == 200) {
                        $('#hdn' + fileType).val("");
                        $('#hasFile-' + fileType).hide();
                        $('#noFile-' + fileType).show();
                        ShowNoty("success", data.message);
                        refresh();
                    } else {
                        ShowNoty("error", data.message);
                    }

                }
            });
        });

        //button to create letter
        $('#btnNewLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/CreateLost?RefNo=" + $("#RefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });
        $('#btnViewLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/LostLetter?LetterRefNo=" + $("#InstructionLetterRefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });
        $('#btnEditLetter').click(function (event) {
            event.preventDefault();
            window.open("/InstructionLetter/EditLost?LetterRefNo=" + $("#InstructionLetterRefNo").val(), "popupWindow", "width=600,height=600,scrollbars=yes");
        });

        $("#btnCreateConfirm").on('click', function (e) {
            console.log('create confirm');
            if ($("#formEditLost").valid()) {
                $("#Status").val("Submit");
                $("#formEditLost").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }

        });

        $("#btnDraft").on('click', function (e) {
            $("#Status").val("Draft");
            $("#formEditLost").submit();
        });

        $('#btnWithdrawConfirm').on('click', function (e) {

            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Withdrawn");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $("#btnApprove").on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Approve");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnRejectApprove').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("RejectApprove");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnAccept').on('click', function (e) {

            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Accept");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnDeclined').on('click', function (e) {
            if ($("#formNextAction").valid()) {
                $("#UserAction").val("Decline");
                $("#formNextAction").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $('#btnProcessBD').on('click', function (e) {
            if ($("#formSubmitToBank").valid()) {
                $("#UserAction").val("SubmitToBank");
                $("#formSubmitToBank").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }
        });

        $("#btnSaveProcess").on('click', function (e) {
            //console.log('create confirm');
            $("#UserAction").val("Draft");
            $("#formSubmitToBank").submit();

        });

        $('#btnReceiveBD').on('click', function (e) {
            if ($("#formReceiveBDLost").valid()) {
                $("#UserAction").val("ReceiveBDLost");
                $("#formReceiveBDLost").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }

        });


        $('#btnCompleteBD').on('click', function (e) {
            if ($("#formConfirmBDLost").valid()) {
                $("#UserAction").val("Complete");
                $("#formConfirmBDLost").submit();
            }
            else {
                ShowNoty("error", "Please fill all required fields!");
            }

        });

        var t = $('#suppDoc').DataTable({ searching: false, paging: false, info: false });

        if ((status == "Draft" || status == "Declined" || status == "Rejected" || status == "Withdrawn") && '@Model.RequesterId' == userId) {
            $.ajax({
                type: "GET",
                url: "/Lost/GetSupportDocument?parentid=" + id + "&fileType=Lost&fileSubType=OthersDoc",
                success: function (data) {

                    $.each(data, function (i, val) {
                        var url = "../../../documents/" + val.fileName;
                        var load = "window.open('" + url + "', '', 'width=900,height=750');"

                        i = i + 1;
                        var link = "RemoveAttachment('" + val.id + "','OthersDoc')";
                        t.row.add([
                            i,
                            //'Attachment ' + i,
                            val.title,
                            '<td class="td-actions"><input type="hidden" value="' + val.fileName + '" id="hdnOthersDoc" /><a href="" onclick="' + load + '">' + val.fileName + '</a></td>',
                            '<a onclick=' + link + ' id="dustbinId"><i class="la la-trash"></i></a>'
                        ]).draw(false);

                        counts = i;
                        counter1 = i;
                    });
                }
            });
        }
        else
        {
            $.ajax({
                type: "GET",
                url: "/Lost/GetSupportDocument?parentid=" + id + "&fileType=Lost&fileSubType=OthersDoc",
                success: function (data) {

                    $.each(data, function (i, val) {
                        var url = "../../../documents/" + val.fileName;
                        var load = "window.open('" + url +"', '', 'width=900,height=750');"
                        i = i + 1;
                        var link = "RemoveAttachment('" + val.id + "','OthersDoc')";
                        t.row.add([
                            i,
                            //'Attachment ' + i,
                            val.title,
                            '<td class="td-actions"><input type="hidden" value="' + val.fileName + '" id="hdnOthersDoc" /><a href="" onclick="' + load + '">' + val.fileName + '</a></td>',
                            '<a onclick=' + link + ' id="dustbinId"></a>'
                        ]).draw(false);

                        counts = i;
                        counter1 = i;
                    });
                }
            });
        }


        counter2 = 0;
        $('#addRow').on('click', function () {
            counts++;

            t.row.add([
                counts,
                //'Attachment ' + counts,
                '<td class="td-actions"><div class="before-submit"><input type="text" id="fname' + counter2 + 'Id" name="fname" class="form-control"></div></td>',
                '<td class="td-actions"><div class="file-upload before-submit"><input id="otherDoc' + counter2 + 'Id" name="doc" type="file"></div></td>',
                '<a id="dustbinId2"><i class="la la-trash"></i></a>'
            ]).draw(false);

            counter2++;
        });

        //$('#suppDoc tbody').on('click', '#dustbinId', function () {
        //    t
        //        .row($(this).parents('tr'))
        //        .remove()
        //        .draw();
        //    counts--;
        //    counter1--;
        //});

        $('#suppDoc tbody').on('click', '#dustbinId2', function () {
            t
                .row($(this).parents('tr'))
                .remove()
                .draw();
            counts--;
            counter2--;
        });

        //// Automatically add a first row of data
        $('#addRow').click();
        $('#dustbinId').click();
        $('#dustbinId2').click();

        $("#formEditLost").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            var amount = $("#jumlah").val();
            fdata.append("BDAmount", convert(amount));

            var fileInput = $('#ScannedPoliceReportVM_File')[0];
            var file = fileInput.files[0];
            fdata.append("ScannedPoliceReport", file);

            var fileInput = $('#ScannedPBTDocVM_File')[0];
            var file = fileInput.files[0];
            fdata.append("ScannedPBTDoc", file);

            for (var i = 0; i < counter2; i++) {
                var fileInput = $('#otherDoc' + i + 'Id')[0];
                var file = fileInput.files[0];
                fdata.append("OthersDoc", file);

                var fileName = $('#fname' + i + 'Id').val();
                fdata.append("OthersDocName", fileName);
            }

            $("input[type='text'], input[type='hidden']").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            // You can update the jquery selector to use a css class if you want
            $("input,textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            for (var value of fdata.values()) {
                console.log(value);
            }
            for (var key of fdata.keys()) {
                console.log(key);
            }

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        if ($("#Status").val() == "Draft") {
                            $('#save-modal').modal('show');
                        }
                        else {
                            $('#create-modal').modal('show');
                        }

                        href = "/Application/MyLost";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);
                    }
                }
            });
        });

        $("#formNextAction").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.
            ShowNoty("warning", "Updating Application..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            //var amount = $("#jumlah").val();
            //fdata.append("BDAmount", convert(amount));

            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    if (data.response.statusCode == 200) {

                        if ($("#UserAction").val() == "Decline") {
                            ShowNoty("success", "Declined Successful");
                        }
                        else {
                            ShowNoty("success", data.message);
                        }

                        if ($("#UserAction").val() == "Approve") {
                            $('#approve-modal').modal('show');
                        }
                        else if ($("#UserAction").val() == "Accept") {
                            $('#accept-modal').modal('show');
                        }

                        if ($("#UserAction").val() == "Withdrawn") {
                            href = "/Lost/Edit/" + data.id;
                        }
                        else {
                            href = "/Application/ManageLost";
                        }
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else if (data.response.statusCode == 500){
                        ShowNoty("error", data.message);

                    }
                }
            });
        });

        $("#formSubmitToBank").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            if ($('#SignedLetterVM_File').get(0).files.length !== 0) {
                var fileInput = $('#SignedLetterVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("SignedLetter", file);
            }

            if ($('#SignedIndemningFormVM_File').get(0).files.length !== 0) {
                var fileInput = $('#SignedIndemningFormVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("SignedIndemningForm", file);
            }

            //fdata.append("BDAmount", convert(totalRecoveryAmount));

            // You can update the jquery selector to use a css class if you want
            $("input, select, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        if ($("#UserAction").val() == "Draft") {
                            $('#save-modal').modal('show');
                        }
                        else {
                            $('#process-modal').modal('show');
                        }


                        href = "/Application/ManageLost";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);

                    }
                }
            });
        });

        $("#formReceiveBDLost").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            if ($('#BankStatementVM_File').get(0).files.length !== 0) {
                var fileInput = $('#BankStatementVM_File')[0];
                var file = fileInput.files[0];
                fdata.append("BankStatement", file);
            }

            // You can update the jquery selector to use a css class if you want
            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        $('#receive-modal').modal('show');

                        href = "/Application/ManageLost";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);

                    }
                }
            });
        });

        $("#formConfirmBDLost").submit(function (e) {

            e.preventDefault(); // avoid to execute the actual submit of the form.

            ShowNoty("warning", "Saving Bank Draft..");

            var form = $(this);
            var url = form.attr('action');
            var fdata = new FormData();

            // You can update the jquery selector to use a css class if you want
            $("input, textarea").each(function (x, y) {
                fdata.append($(y).attr("name"), $(y).val());
            });

            $.ajax({
                type: "POST",
                url: url,
                data: fdata, //form.serialize(), // serializes the form's elements.
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.response.statusCode == 200) {
                        ShowNoty("success", data.message);
                        $('#complete-modal').modal('show');

                        href = "/Application/ManageLost";
                        setTimeout(function () {
                            window.location.href = href;
                        }, 3000);
                    } else {
                        ShowNoty("error", data.message);

                    }
                }
            });
        });

    </script>

}


